generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

// --- ENUMS (Core Business Logic) ---

enum UserRole {
  ADMIN
  WORKER
  JOB_PROVIDER
}

enum JobStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  ESCROW_HELD
  RELEASED
  REFUNDED
}

// --- MODELS ---

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(JOB_PROVIDER)
  createdAt    DateTime @default(now())

  // Relationships
  workerProfile WorkerProfile?
  clientProfile ClientProfile? // New: Separates auth from client details
  
  postedJobs    Job[]
  paymentsSent  Payment[]      @relation("Payer")
  paymentsRecv  Payment[]      @relation("Payee")
  
  reviewsGiven    Review[]     @relation("Reviewer")
  reviewsReceived Review[]     @relation("ReviewTarget")
}

model ClientProfile {
  id            String  @id @default(cuid())
  userId        String  @unique
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fullName      String
  phoneNumber   String
  cnicNumber    String  @unique 
  cnicPhoto     String? @db.Text 

  // --- ADD THESE TWO LINES ---
  paymentType   String  
  accountNumber String
  // ---------------------------

  province      String
  district      String
  tehsil        String
  
  isVerified    Boolean @default(false)
}


model WorkerProfile {
  id            String  @id @default(cuid())
  userId        String  @unique
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fullName      String
  phoneNumber   String
  bio           String? @db.Text
  
  // Updated Identity
  cnicNumber    String  @unique // Mandatory 13-digit number
  cnicEncrypted String? @db.Text // Optional Photo for authenticity
  
  // New: Hierarchical Location for Worker Discovery
  province      String
  district      String
  tehsil        String
  
  // New: Universal Financial Details
  paymentType   String  // "JazzCash", "EasyPaisa", "Bank", etc.
  accountNumber String  // 11 digits for wallets or IBAN for banks
  
  skills        Json    // Skills array e.g., ["Electrician", "Plumber"]
  isVerified    Boolean @default(false)
  
  applications Application[]
}

model Job {
  id          String    @id @default(uuid())
  clientId    String
  client      User      @relation(fields: [clientId], references: [id])
  
  title       String
  category    String    
  
  // Updated: Structured location for filtering
  province    String
  district    String
  tehsil      String
  
  budget      Decimal
  urgency     String    @default("Standard")
  description String    @db.Text
  status      JobStatus @default(OPEN)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt 

  applications Application[]
  payment      Payment?
  reviews      Review[]       
}

model Application {
  id       String        @id @default(uuid())
  jobId    String
  job      Job           @relation(fields: [jobId], references: [id])
  workerId String
  worker   WorkerProfile @relation(fields: [workerId], references: [id])

  message   String?      @db.Text // Optional cover letter for application
  status    String       @default("PENDING") 
  appliedAt DateTime     @default(now())
}

model Payment {
  id    String @id @default(uuid())
  jobId String @unique
  job   Job    @relation(fields: [jobId], references: [id])

  payerId String
  payer   User   @relation("Payer", fields: [payerId], references: [id])
  payeeId String
  payee   User   @relation("Payee", fields: [payeeId], references: [id])

  amount        Decimal
  jazzCashTrxId String        @unique
  status        PaymentStatus @default(PENDING)
  createdAt     DateTime      @default(now())
}

model Review {
  id         String  @id @default(uuid())
  jobId      String
  job        Job     @relation(fields: [jobId], references: [id])
  reviewerId String
  reviewer   User    @relation("Reviewer", fields: [reviewerId], references: [id])
  targetId   String
  target     User    @relation("ReviewTarget", fields: [targetId], references: [id])
  
  rating     Int     
  comment    String? @db.Text
  createdAt  DateTime @default(now())
}